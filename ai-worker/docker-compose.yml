version: "3.8"

services:
  ai-worker:
    build:
      context: .
      args:
        GITHUB_TOKEN: ${GITHUB_TOKEN:-}
    image: ai-worker:latest
    container_name: ai-worker
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
       - ./cookies:/app/cookies
       - ./sofa/models:/app/sofa/models:ro
    environment:
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-kero}
      - RABBITMQ_PASS=${RABBITMQ_PASS}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-ap-northeast-2}
      - S3_BUCKET=${S3_BUCKET:-kero-audio-bucket}
      - PROCESSING_SECRET=${PROCESSING_SECRET}
      - BACKEND_API_URL=${BACKEND_API_URL:-https://kero.ooo}
      - TEMP_DIR=${TEMP_DIR:-/tmp/kero-ai}
      - USE_SOFA_ALIGNER=${USE_SOFA_ALIGNER:-false}
      - SOFA_MODEL_PATH=${SOFA_MODEL_PATH:-}
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
